#!/bin/bash
exec 2>/tmp/ty-wrapper.log

# If already in a venv, just run ty
if [[ -n "$VIRTUAL_ENV" ]]; then
    exec ty server
    exit
fi

helix_cwd=$(lsof -a -p $PPID -d cwd -Fn 2>/dev/null | grep '^n' | cut -c2-)
last_hx=$(grep -a ";hx " ~/.zsh_history | grep -v "grep" | tail -1 | sed 's/.*;hx //' | awk '{print $1}')

if [[ -n "$helix_cwd" && -n "$last_hx" ]]; then
    if [[ "$last_hx" = /* ]]; then
        script_path="$last_hx"
    else
        script_path="$helix_cwd/$last_hx"
    fi
    
    if [[ -f "$script_path" ]] && head -20 "$script_path" | grep -q '# /// script'; then
        tmp=$(mktemp /tmp/pep723.XXXXXX.py)
        sed -n '/^# \/\/\/ script/,/^# \/\/\/$/p' "$script_path" > "$tmp"
        echo 'import sys; print(sys.prefix)' >> "$tmp"
        
        VIRTUAL_ENV=$(cd "$helix_cwd" && uv run "$tmp" 2>/dev/null)
        rm -f "$tmp"
        
        if [[ -d "$VIRTUAL_ENV" ]]; then
            export VIRTUAL_ENV
        fi
    fi
fi

exec ty server
